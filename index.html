<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>‚õèÔ∏è Mine Endiorite</title>
<style>
*{box-sizing:border-box;}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#0f172a,#020617);font-family:system-ui,Arial,sans-serif;color:#f0f9ff;display:flex;justify-content:center;align-items:center;padding:20px;}
.card{width:100%;max-width:480px;background:#0b1120;border-radius:16px;padding:24px;border:1px solid #1e3a8a;box-shadow:0 10px 40px rgba(0,0,0,0.8),0 0 20px rgba(30,58,138,0.2);}
h1,h2,h3{text-align:center;margin:12px 0;color:#60a5fa;}
h1{font-size:1.8rem;}
input{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#bfdbfe;font-size:16px;}
input:focus{border-color:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,0.3);}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-weight:700;font-size:16px;cursor:pointer;transition:0.2s;}
button:hover{opacity:.9;}
button:active{transform:scale(0.98);}
.secondary{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
.msg{text-align:center;color:#7dd3fc;font-size:14px;margin:10px 0;min-height:20px;}
.credit-box{text-align:center;font-size:24px;font-weight:bold;margin:15px 0;color:#3b82f6;text-shadow:0 0 10px rgba(59,130,246,0.4);}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-top:15px;}
.cell{width:50px;height:50px;background:#020617;border:1px solid #1e293b;border-radius:6px;display:flex;justify-content:center;align-items:center;font-weight:bold;font-size:18px;cursor:pointer;transition:0.2s;}
.cell.revealed{background:#1e293b;cursor:default;color:#fff;}
</style>
</head>
<body>

<div class="card">
<h1>‚õèÔ∏è Mine Endiorite</h1>
<div class="credit-box">üí∞ <span id="credits">0</span> cr√©dits</div>

<input id="bet" type="number" placeholder="Mise max 500">
<div style="display:flex;gap:10px;">
<button id="startBtn">‚ñ∂ Commencer</button>
<button id="cashOutBtn" class="secondary" disabled>üí∞ Encaisser</button>
</div>
<div class="msg" id="resultMsg"></div>
<div class="grid" id="mineGrid"></div>

<button id="backBtn" class="secondary">‚¨Ö Retour</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAQALLN99kqiYY4UZz9wl2stedP5KQ5mA",
  authDomain: "casino-b23c9.firebaseapp.com",
  databaseURL: "https://casino-b23c9-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "casino-b23c9",
  storageBucket: "casino-b23c9.appspot.com",
  messagingSenderId: "139229793155",
  appId: "1:139229793155:web:953b31b383a87bc3c504b6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Utilisateur
const currentUser = localStorage.getItem("casinoUser");
if(!currentUser){
  alert("Vous devez vous connecter !");
  window.location.href="https://kikoco16.github.io/Casino-Endiorite/";
}

// DOM
const creditsEl = document.getElementById("credits");
const betInput = document.getElementById("bet");
const startBtn = document.getElementById("startBtn");
const cashOutBtn = document.getElementById("cashOutBtn");
const resultMsg = document.getElementById("resultMsg");
const mineGrid = document.getElementById("mineGrid");
const backBtn = document.getElementById("backBtn");

let grid = [], bet = 0, tempGains = 0, revealed = [];

// Minerais et multiplicateurs
const minerals = [
  {name:"Fer",mult:1.5},
  {name:"Or",mult:1.75},
  {name:"Diamant",mult:2},
  {name:"Netherite",mult:3}
];

function refreshCredits(){
  get(ref(db,"users/"+currentUser)).then(snap=>{
    creditsEl.textContent = snap.val().credits;
  });
}

// Cr√©er la grille
function createGrid(){
  const cells = Array(25).fill("Pierre");

  // Ajouter 3 TNT
  let tntIndices = [];
  while(tntIndices.length<5){
    let i=Math.floor(Math.random()*25);
    if(!tntIndices.includes(i)){
      tntIndices.push(i);
      cells[i]="TNT";
    }
  }

  // Ajouter 5 minerais al√©atoires
  let mineralIndices = [];
  while(mineralIndices.length<3){
    let i=Math.floor(Math.random()*25);
    if(cells[i]==="Pierre" && !mineralIndices.includes(i)){
      mineralIndices.push(i);
      const m = minerals[Math.floor(Math.random()*minerals.length)];
      cells[i]=m.name;
    }
  }

  return cells;
}

// Montrer grille
function renderGrid(){
  mineGrid.innerHTML="";
  for(let i=0;i<25;i++){
    const div = document.createElement("div");
    div.className="cell";
    div.dataset.index=i;
    div.textContent="";
    div.onclick = () => revealCell(i,div);
    mineGrid.appendChild(div);
  }
}

// Tirage cellule
async function revealCell(i, div) {
  if (revealed.includes(i)) return;
  revealed.push(i);

  const val = grid[i];
  div.classList.add("revealed");

  // Emoji selon le type
  let display = "";
  if (val === "Pierre") display = "‚¨õ";
  else if (val === "TNT") display = "üß®";
  else if (val === "Fer") display = "‚õèÔ∏è";
  else if (val === "Or") display = "ü•á";
  else if (val === "Diamant") display = "üíé";
  else if (val === "Netherite") display = "‚ö´Ô∏è";

  div.textContent = display;

  // üí• TNT ‚Üí perte + argent vers Banque Centrale
  if (val === "TNT") {
    const userRef = ref(db, "users/" + currentUser);
    const bankRef = ref(db, "users/Banque Centrale");

    const userSnap = await get(userRef);
    const bankSnap = await get(bankRef);

    const userCredits = userSnap.val().credits;
    const userBalance = userSnap.val().balance || 0;

    const bankCredits = bankSnap.exists() ? bankSnap.val().credits : 0;
    const bankBalance = bankSnap.exists() ? (bankSnap.val().balance || 0) : 0;

    // Retirer au joueur
    await update(userRef, {
      credits: userCredits - bet,
      balance: userBalance - bet,
      password: userSnap.val().password
    });

    // Ajouter √† la Banque Centrale
    await update(bankRef, {
      credits: bankCredits + bet,
      balance: bankBalance + bet
    });

    resultMsg.textContent = "üí• BOOM ! Vous avez perdu votre pari !";
    tempGains = 0;
    endGame();
    return;
  }

  // ‚õèÔ∏è Minerai ‚Üí gains temporaires
  if (val !== "Pierre") {
    const mult = minerals.find(m => m.name === val)?.mult || 1;
    const gain = Math.round(bet * mult);
    tempGains += gain;
    resultMsg.textContent =
      `üí∞ Vous avez trouv√© ${val} ! +${gain} cr√©dits (Total temporaire: ${tempGains})`;
    cashOutBtn.disabled = false;
  }
}

// Fin de partie
async function endGame(cashedOut=false){
  // mettre √† jour cr√©dits si encaissement
  if(cashedOut){
    const snap = await get(ref(db,"users/"+currentUser));
    await update(ref(db,"users/"+currentUser),{
      credits: snap.val().credits + tempGains,
      balance: (snap.val().balance||0) + tempGains,
      password: snap.val().password
    });
    resultMsg.textContent += " ‚úÖ Encaissement effectu√© !";
  }
  startBtn.disabled=false;
  cashOutBtn.disabled=true;
  revealed=[];
  tempGains=0;
  mineGrid.innerHTML="";
  refreshCredits();
}

// D√©marrer
startBtn.onclick = async () => {
  bet = Number(betInput.value);
  if(bet<=0 || bet>500){ resultMsg.textContent="Mise invalide (max 500)"; return; }

  const snap = await get(ref(db,"users/"+currentUser));
  if(bet>snap.val().credits){ resultMsg.textContent="Cr√©dits insuffisants"; return; }

  startBtn.disabled=true;
  cashOutBtn.disabled=true;
  tempGains=0;
  revealed=[];
  grid = createGrid();
  renderGrid();
  resultMsg.textContent="‚õèÔ∏è Commencez √† creuser !";
};

// Encaisser
cashOutBtn.onclick = () => endGame(true);

backBtn.onclick=()=>window.location.href="https://kikoco16.github.io/Casino-Endiorite/";

refreshCredits();
</script>
</body>
</html>
