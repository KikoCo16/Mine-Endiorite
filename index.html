<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ðŸŽ£ PÃªche Endiorite</title>
<style>
*{box-sizing:border-box;}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#0f172a,#020617);font-family:system-ui,Arial,sans-serif;color:#f0f9ff;display:flex;justify-content:center;align-items:center;padding:20px;}
.card{width:100%;max-width:420px;background:#0b1120;border-radius:16px;padding:24px;border:1px solid #1e3a8a;box-shadow:0 10px 40px rgba(0,0,0,0.8),0 0 20px rgba(30,58,138,0.2);}
h1,h2,h3{text-align:center;margin:12px 0;color:#60a5fa;}
h1{font-size:1.8rem;}
input,select{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#bfdbfe;font-size:16px;}
input:focus,select:focus{border-color:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,0.3);}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-weight:700;font-size:16px;cursor:pointer;transition:0.2s;}
button:hover{opacity:.9;}
button:active{transform:scale(0.98);}
.secondary{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
.msg{text-align:center;color:#7dd3fc;font-size:14px;margin:10px 0;min-height:20px;}
.credit-box{text-align:center;font-size:24px;font-weight:bold;margin:15px 0;color:#3b82f6;text-shadow:0 0 10px rgba(59,130,246,0.4);}
.section{margin-top:20px;border-top:1px solid #1e293b;padding-top:15px;}
</style>
</head>
<body>

<div class="card">
<h1>ðŸŽ£ PÃªche Endiorite</h1>
<div class="credit-box">ðŸ’° <span id="credits">0</span> crÃ©dits</div>

<div class="section">
  <h3>Choisir la zone</h3>
  <select id="zoneSelect"></select>
  <div class="msg" id="zoneMsg"></div>
</div>

<div class="section">
  <input id="bet" type="number" placeholder="Mise (max 500)">
  <button id="fishBtn" class="secondary" disabled>ðŸŽ£ PÃªcher</button>
  <div class="msg" id="resultMsg"></div>
</div>

<button id="backBtn" class="secondary">â¬… Retour</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAQALLN99kqiYY4UZz9wl2stedP5KQ5mA",
  authDomain: "casino-b23c9.firebaseapp.com",
  databaseURL: "https://casino-b23c9-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "casino-b23c9",
  storageBucket: "casino-b23c9.appspot.com",
  messagingSenderId: "139229793155",
  appId: "1:139229793155:web:953b31b383a87bc3c504b6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Utilisateur
const currentUser = localStorage.getItem("casinoUser");
if(!currentUser){
  alert("Vous devez vous connecter !");
  window.location.href="https://kikoco16.github.io/Casino-Endiorite/";
}

// DOM
const creditsEl = document.getElementById("credits");
const betInput = document.getElementById("bet");
const fishBtn = document.getElementById("fishBtn");
const resultMsg = document.getElementById("resultMsg");
const backBtn = document.getElementById("backBtn");
const zoneSelect = document.getElementById("zoneSelect");
const zoneMsg = document.getElementById("zoneMsg");

let currentZone = 1;
let unlockedZones = [1];

// ProbabilitÃ©s
const zones = {
  1: [
    {name:"Rien",mult:0,prob:30},
    {name:"BÃ¢ton",mult:0.5,prob:30},
    {name:"Morue",mult:1.15,prob:39},
    {name:"Code",mult:1,prob:1,unlock:2}
  ],
  2: [
    {name:"Rien",mult:0,prob:30},
    {name:"BÃ¢ton",mult:0.5,prob:20},
    {name:"Morue",mult:1.15,prob:25},
    {name:"Saumon",mult:1.5,prob:17},
    {name:"Poisson tropical",mult:2,prob:7},
    {name:"Code",mult:1,prob:1,unlock:3}
  ],
  3: [
    {name:"Rien",mult:0,prob:30},
    {name:"BÃ¢ton",mult:0.5,prob:15},
    {name:"Morue",mult:1.15,prob:20},
    {name:"Saumon",mult:1.5,prob:18},
    {name:"Poisson tropical",mult:2,prob:10},
    {name:"Poisson globe",mult:3,prob:5},
    {name:"Trident",mult:5,prob:2}
  ]
};

// Charger crÃ©dits + zones dÃ©bloquÃ©es
async function refreshCredits(){
  const snap = await get(ref(db,"users/"+currentUser));
  creditsEl.textContent = snap.val().credits;
  if(snap.val().unlockedZones) unlockedZones = snap.val().unlockedZones;
  updateZoneSelect();
}

// Menu dÃ©roulant
function updateZoneSelect(){
  zoneSelect.innerHTML = "";
  for(let z=1; z<=3; z++){
    const opt = document.createElement("option");
    opt.value = z;
    if(unlockedZones.includes(z)){
      opt.textContent = "Zone "+z+" ðŸŒŠ";
      opt.disabled = false;
    } else {
      opt.textContent = "Zone "+z+" ðŸŒŠ (bloquÃ©e)";
      opt.disabled = true;
    }
    zoneSelect.appendChild(opt);
  }
  currentZone = unlockedZones[unlockedZones.length-1]; 
  zoneSelect.value = currentZone;
  zoneMsg.textContent = "Vous avez choisi la zone "+currentZone;
  fishBtn.disabled = false;
}

zoneSelect.onchange = () => {
  currentZone = Number(zoneSelect.value);
  zoneMsg.textContent = "Vous avez choisi la zone "+currentZone;
  resultMsg.textContent = "";
};

// Tirage alÃ©atoire
function drawFish(){
  const rand = Math.random()*100;
  let sum=0;
  for(let f of zones[currentZone]){
    sum+=f.prob;
    if(rand <= sum) return f;
  }
  return zones[currentZone][0]; 
}

// PÃªcher avec animation
fishBtn.onclick = async () => {
  let bet = Number(betInput.value);
  if(bet <= 0 || bet > 500){ 
    resultMsg.textContent = "Mise invalide (max 500)"; 
    return; 
  }

  const snap = await get(ref(db,"users/"+currentUser));
  if(!snap.exists()) return;

  if(bet > snap.val().credits){
    resultMsg.textContent = "CrÃ©dits insuffisants";
    return;
  }

  // Animation
  resultMsg.textContent = "ðŸŽ£ En train de pÃªcher...";
  resultMsg.style.opacity = 0;
  let blink = 0;
  const anim = setInterval(()=>{
    resultMsg.style.opacity = blink % 2 === 0 ? 1 : 0.3;
    blink++;
    if(blink > 5) clearInterval(anim);
  },200);

  setTimeout(async ()=>{
    const fish = drawFish();
    let gain = Math.round(bet * fish.mult);
    if(fish.mult === 0) gain = 0;

    resultMsg.style.opacity = 1;
    resultMsg.textContent = `Vous avez pÃªchÃ© : ${fish.name} â†’ ${gain} crÃ©dits`;

    const userCredits = snap.val().credits;
    const userBalance = snap.val().balance || 0;

    // Zones dÃ©bloquÃ©es
    const newZones = fish.unlock
      ? [...new Set([...unlockedZones, fish.unlock])]
      : unlockedZones;

    // ðŸ”¹ Banque Centrale
    const bankSnap = await get(ref(db,"users/Banque Centrale"));
    const bankCredits = bankSnap.exists() ? bankSnap.val().credits : 0;
    const bankBalance = bankSnap.exists() ? bankSnap.val().balance : 0;

    let bankTake = 0;

    if(fish.mult === 0){
      // âŒ Perte totale
      bankTake = bet;
    } else if(fish.mult === 0.5){
      // âš ï¸ BÃ¢ton â†’ 50% Ã  la banque
      bankTake = Math.floor(bet / 2);
    }

    // Mise Ã  jour joueur
    await update(ref(db,"users/"+currentUser),{
      credits: userCredits - bet + gain,
      balance: userBalance - bet + gain,
      unlockedZones: newZones,
      password: snap.val().password
    });

    // Mise Ã  jour banque si nÃ©cessaire
    if(bankTake > 0){
      await update(ref(db,"users/Banque Centrale"),{
        credits: bankCredits + bankTake,
        balance: bankBalance + bankTake
      });
    }

    unlockedZones = newZones;
    refreshCredits();
  },1200);
};

backBtn.onclick=()=>window.location.href="https://kikoco16.github.io/Casino-Endiorite/";

refreshCredits();
</script>
</body>
</html>
